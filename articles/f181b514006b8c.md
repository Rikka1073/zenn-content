---
title: "GitHub Actions ã§EC2 ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹CI/CD ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹"
emoji: "ğŸ˜½"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "ec2", "githubactions", "cicd"]
published: false
publication_name: "jisou"
---

# ã¯ã˜ã‚ã«

ä»Šå›ã¯ Github Actoins ã‚’ä½¿ã£ã¦ EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã« CI/CD ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ã€‚
EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®è¨­å®šæ–¹æ³•ã«ã¤ã„ã¦ã¯ä¸‹è¨˜ã®è¨˜äº‹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚

https://zenn.dev/jisou/articles/5f90cfa51986c8

# éµã®ç”Ÿæˆã¨ç™»éŒ²

## éµã®ç”Ÿæˆ

GitHub Actions ãŒ EC2 ã« SSH æ¥ç¶šã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®éµã‚’ä½œæˆã—ã¾ã™ã€‚

1. EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«æ¥ç¶šã—ã¾ã™ã€‚

```
ssh -i ~/.ssh/xxx.pem ec2-user@IPã‚¢ãƒ‰ãƒ¬ã‚¹
```

2. .ssh ã«ç§»å‹•ã—ã¾ã™ã€‚

```
cd ~/.ssh
```

3. éµã‚’ä½œæˆã—ã¾ã™ã€‚

```
ssh-keygen -t rsa
```

4. å…¨ã¦ Enter ã‚’æŠ¼ã™ã¨ id_rsaï¼ˆç§˜å¯†éµï¼‰id_rsa.pubï¼ˆå…¬é–‹éµï¼‰ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```
Enter file in which to save the key ():  // Enter
Enter passphrase (empty for no passphrase):  // Enter
Enter same passphrase again:  // Enter
```

5. .ssh ã§ ls ã‚³ãƒãƒ³ãƒ‰ã§ä¸‹è¨˜ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°å®Œäº†ã§ã™ã€‚

```
authorized_keys  id_rsa  id_rsa.pub
```

6. å…¬é–‹éµã‚’ EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã® ~/.ssh/authorized_keys ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ã—ã¾ã™ã€‚æ—¢å­˜ã®ã‚­ãƒ¼ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤ã›ãšæ–°ã—ã„è¡Œã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

- å…¬é–‹éµã®å†…å®¹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

```
cat ~/.ssh/id_rsa.pub
```

- è¡¨ç¤ºã•ã‚ŒãŸå†…å®¹ã‚’ã€EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã® ~/.ssh/authorized_keys ã«è¿½åŠ ã—ã¾ã™ã€‚

```
ssh-rsa xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx //æ—¢å­˜ã®ã‚­ãƒ¼

ssh-rsa 00000000000000000000000000000000000000000000000 //è¿½åŠ ã™ã‚‹ã‚­ãƒ¼
```

## éµã®ç™»éŒ²

ç”Ÿæˆã—ãŸéµã‚’ GitHub ã«ç™»éŒ²ã—ã¦ã„ãã¾ã™ã€‚

1. ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§éµã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™

```
$ cat ~/.ssh/id_rsa.pub
```

2. Github ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™

![](https://storage.googleapis.com/zenn-user-upload/018de788cfb7-20250420.png)

3. Settings ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™

![](https://storage.googleapis.com/zenn-user-upload/3ebc5b2e60dd-20250420.png)

4. SSH and GPG keys ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™

![](https://storage.googleapis.com/zenn-user-upload/10e486dc9cca-20250420.png)

5. New SSH key ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™

![](https://storage.googleapis.com/zenn-user-upload/08c7304d13f0-20250420.png)

6. ä»Šå›å…¥åŠ›ã™ã‚‹è¨­å®šé …ç›®ã§ã™ã€‚Title ã«ã¯è¦ä»¶ã«åˆã†é©å½“ãªåå‰ã‚’ã¤ã‘ã€key ã®éƒ¨åˆ†ã«ç§˜å¯†éµã®ä¸­èº«ã‚’å…¥ã‚Œã¾ã™ã€‚

| é …ç›®  | å€¤              |
| ----- | --------------- |
| Title | ec2_auto_deploy |
| Key   | å…¬é–‹éµã®ä¸­èº«    |

- å…¬é–‹éµã®å†…å®¹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

```
cat ~/.ssh/id_rsa.pub
```

- Title ã«ã¯è¦ä»¶ã«åˆã†é©å½“ãªåå‰ã‚’ã¤ã‘ã€key ã®éƒ¨åˆ†ã«å…¬é–‹éµã®ä¸­èº«ã‚’å…¥ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/23b533125f9d-20250420.png)

7. å…¥åŠ›å†…å®¹ãŒå•é¡Œãªã‘ã‚Œã° Add ssh key ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/142031912428-20250420.png)

8. Authentication keys ã®ã‚¢ã‚¤ã‚³ãƒ³ãªã©ãŒç°è‰²ã«ãªã£ã¦ã„ã‚Œã°å®Œäº†ã§ã™ã€‚æ¥ç¶šãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¨ç·‘è‰²ã«å¤‰åŒ–ã—ã¾ã™ã€‚

# Github ã« Secrets æƒ…å ±ã‚’ç™»éŒ²

Github ã« Secrets æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ã„ãã¾ã™ã€‚

1. è©²å½“ã®ãƒ¬ãƒã‚¸ãƒˆãƒªã® Settings ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/18efbfa5fb20-20250420.png)

2. ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä¸­ã‹ã‚‰ Actions ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/d4951ba5dc33-20250420.png)

3. New repository secret ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/25749d09bb27-20250420.png)

4. ä»Šå›å…¥åŠ›ã™ã‚‹è¨­å®šé …ç›®ã§ã™ã€‚

| Name                  | Secret                                            | ä¾‹                                     |
| --------------------- | ------------------------------------------------- | -------------------------------------- |
| AWS_ACCESS_KEY        | ä½œæˆã—ãŸ IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ãƒ¼             | IAM ã§å–å¾—ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼             |
| AWS_SECRET_ACCESS_KEY | ä½œæˆã—ãŸ IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼   | IAM ã§å–å¾—ã—ãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ |
| EC2_SECURITY_GROUP_ID | EC2 ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã® ID | sg-xxxxxxxx                            |
| HOST_NAME             | EC2 ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹                                | ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ãªã©                     |
| PRIVATE_KEY           | ç§˜å¯†éµ                                            | ç”Ÿæˆã—ãŸç§˜å¯†éµã® id_rsa ã®ä¸­èº«         |
| USER_NAME             | ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ã® username                       | ec2-user                               |

ã“ã®ã‚ˆã†ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚Œã°å®Œäº†ã§ã™ã€‚ã“ã‚Œã‚‰ã®è¨­å®šã¯ã“ã®å¾Œã®ã® workflow ã®è¨­å®šã§ä½¿ã„ã¾ã™ã€‚
Secrets æƒ…å ±ã®ç™»éŒ²ã«ã‚ˆã‚Šã€GitHub Actions ã®ã‚¸ãƒ§ãƒ–ã‚’è¨˜è¿°ã™ã‚‹ YAML ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¤‰æ•°ã¨ã—ã¦å‚ç…§ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/d7dc7648f4fe-20250420.png)

# Github Actions ã® workflow ã‚’ä½œæˆ

1. ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ•ã‚©ãƒ«ãƒ€ã« GitHub Actions ã® Workflow ã‚’ä½œæˆã—ã¾ã™ã€‚

- github/workflows/ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã™

```
mkdir -p .github/workflows/
```

- yml ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™

```
touch main.yml
```

2. yml ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸‹è¨˜ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```
name: EC2 auto deploy
on:
push:
branches: - main
workflow_dispatch:

jobs:
deploy:
runs-on: ubuntu-latest
steps:

      # Branchã‚’Checkout
      - name: Checkout code
        uses: actions/Checkout@v4

      # IPå–å¾—ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Public IP Install
        id: ip
        uses: haythem/public-ip@v1.3

      # AWS CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
      - name: AWS CLI install
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update
          aws --version

      # AWS CLIã«ã‚­ãƒ¼ã‚’è¨­å®šã‚’ã™ã‚‹
      - name: AWS set Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      # ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
      - name: Deploy
        run: |

          # SSHã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é–‹æ”¾ã™ã‚‹
          aws ec2 authorize-security-group-ingress --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32
          echo "${{ secrets.PRIVATE_KEY }}" > private_key
          chmod 600 private_key

          # SSHæ¥ç¶šã—ã¦ã€git pullã¨git buildã™ã‚‹
          ssh -oStrictHostKeyChecking=no ${{ secrets.USER_NAME }}@${{ secrets.HOST_NAME }} -i private_key "cd /home/ec2-user/aws-react-vite && git fetch --prune && git checkout main && git pull origin main && npm install && npm run build"

          # SSHã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é–‰ã˜ã‚‹
          aws ec2 revoke-security-group-ingress --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32

```

3. ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã«å¤‰æ›´ã—ã¦ git push ã‚’ã—ã¾ã™ã€‚

4. github actions ãŒä¸‹è¨˜ã®ã‚ˆã†ãªç”»é¢ã«ãªã£ã¦ã„ã‚Œã°æˆåŠŸã§ã™ã€‚
