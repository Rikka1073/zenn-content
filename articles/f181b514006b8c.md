---
title: "GitHub Actions でEC2 にデプロイするCI/CD 環境を構築する"
emoji: "😽"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["aws", "ec2", "githubactions", "cicd"]
published: false
publication_name: "jisou"
---

# はじめに

今回は Github Actoins を使って EC2 インスタンスに CI/CD できるようにしていきます。
EC2 インスタンスの設定方法については下記の記事をご確認ください。

https://zenn.dev/jisou/articles/5f90cfa51986c8

# 鍵の生成と登録

## 鍵の生成

GitHub Actions が EC2 に SSH 接続でアクセスできるようにするための鍵を作成します。

1. EC2 インスタンスに接続します。

```
ssh -i ~/.ssh/xxx.pem ec2-user@IPアドレス
```

2. .ssh に移動します。

```
cd ~/.ssh
```

3. 鍵を作成します。

```
ssh-keygen -t rsa
```

4. 全て Enter を押すと id_rsa（秘密鍵）id_rsa.pub（公開鍵）が生成されます。

```
Enter file in which to save the key ():  // Enter
Enter passphrase (empty for no passphrase):  // Enter
Enter same passphrase again:  // Enter
```

5. .ssh で ls コマンドで下記のように表示されていれば完了です。

```
authorized_keys  id_rsa  id_rsa.pub
```

6. 公開鍵を EC2 インスタンスの ~/.ssh/authorized_keys ファイルに追加します。既存のキーが作成されている場合は削除せず新しい行に追加してください。

- 公開鍵の内容を表示します。

```
cat ~/.ssh/id_rsa.pub
```

- 表示された内容を、EC2 インスタンスの ~/.ssh/authorized_keys に追加します。

```
ssh-rsa xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx //既存のキー

ssh-rsa 00000000000000000000000000000000000000000000000 //追加するキー
```

## 鍵の登録

生成した鍵を GitHub に登録していきます。

1. 以下のコマンドで鍵をコピーします

```
$ cat ~/.ssh/id_rsa.pub
```

2. Github のプロフィールアイコンをクリックします

![](https://storage.googleapis.com/zenn-user-upload/018de788cfb7-20250420.png)

3. Settings をクリックします

![](https://storage.googleapis.com/zenn-user-upload/3ebc5b2e60dd-20250420.png)

4. SSH and GPG keys をクリックします

![](https://storage.googleapis.com/zenn-user-upload/10e486dc9cca-20250420.png)

5. New SSH key をクリックします

![](https://storage.googleapis.com/zenn-user-upload/08c7304d13f0-20250420.png)

6. 今回入力する設定項目です。Title には要件に合う適当な名前をつけ、key の部分に秘密鍵の中身を入れます。

| 項目  | 値              |
| ----- | --------------- |
| Title | ec2_auto_deploy |
| Key   | 公開鍵の中身    |

- 公開鍵の内容を表示します。

```
cat ~/.ssh/id_rsa.pub
```

- Title には要件に合う適当な名前をつけ、key の部分に公開鍵の中身を入れます。

![](https://storage.googleapis.com/zenn-user-upload/23b533125f9d-20250420.png)

7. 入力内容が問題なければ Add ssh key をクリックします。

![](https://storage.googleapis.com/zenn-user-upload/142031912428-20250420.png)

8. Authentication keys のアイコンなどが灰色になっていれば完了です。接続ができるようになると緑色に変化します。

# Github に Secrets 情報を登録

Github に Secrets 情報を登録していきます。

1. 該当のレポジトリの Settings をクリックします。

![](https://storage.googleapis.com/zenn-user-upload/18efbfa5fb20-20250420.png)

2. アコーディオンメニューの中から Actions をクリックします。

![](https://storage.googleapis.com/zenn-user-upload/d4951ba5dc33-20250420.png)

3. New repository secret ボタンをクリックします。

![](https://storage.googleapis.com/zenn-user-upload/25749d09bb27-20250420.png)

4. 今回入力する設定項目です。

| Name                  | Secret                                            | 例                                     |
| --------------------- | ------------------------------------------------- | -------------------------------------- |
| AWS_ACCESS_KEY        | 作成した IAM ユーザーのアクセスキーー             | IAM で取得したアクセスキー             |
| AWS_SECRET_ACCESS_KEY | 作成した IAM ユーザーのシークレットアクセスキー   | IAM で取得したシークレットアクセスキー |
| EC2_SECURITY_GROUP_ID | EC2 にアタッチされているセキュリティグループの ID | sg-xxxxxxxx                            |
| HOST_NAME             | EC2 の IP アドレス                                | パブリック IP など                     |
| PRIVATE_KEY           | 秘密鍵                                            | 生成した秘密鍵の id_rsa の中身         |
| USER_NAME             | サーバーログインの username                       | ec2-user                               |

このように登録されていれば完了です。これらの設定はこの後のの workflow の設定で使います。
Secrets 情報の登録により、GitHub Actions のジョブを記述する YAML ファイルから変数として参照することができます。

![](https://storage.googleapis.com/zenn-user-upload/d7dc7648f4fe-20250420.png)

# Github Actions の workflow を作成

1. デプロイしたいローカルのフォルダに GitHub Actions の Workflow を作成します。

- github/workflows/フォルダを作成します

```
mkdir -p .github/workflows/
```

- yml ファイルを作成します

```
touch main.yml
```

2. yml ファイルを下記のように設定します。

```
name: EC2 auto deploy
on:
push:
branches: - main
workflow_dispatch:

jobs:
deploy:
runs-on: ubuntu-latest
steps:

      # BranchをCheckout
      - name: Checkout code
        uses: actions/Checkout@v4

      # IP取得ライブラリをインストール
      - name: Public IP Install
        id: ip
        uses: haythem/public-ip@v1.3

      # AWS CLIをインストールする
      - name: AWS CLI install
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update
          aws --version

      # AWS CLIにキーを設定をする
      - name: AWS set Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      # デプロイする
      - name: Deploy
        run: |

          # SSHのセキュリティグループを開放する
          aws ec2 authorize-security-group-ingress --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32
          echo "${{ secrets.PRIVATE_KEY }}" > private_key
          chmod 600 private_key

          # SSH接続して、git pullとgit buildする
          ssh -oStrictHostKeyChecking=no ${{ secrets.USER_NAME }}@${{ secrets.HOST_NAME }} -i private_key "cd /home/ec2-user/aws-react-vite && git fetch --prune && git checkout main && git pull origin main && npm install && npm run build"

          # SSHのセキュリティグループを閉じる
          aws ec2 revoke-security-group-ingress --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32

```

3. ローカルフォルダに変更して git push をします。

4. github actions が下記のような画面になっていれば成功です。
